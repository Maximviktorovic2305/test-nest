# Система бронирования событий

Масштабируемая backend-система для бронирования событий, построенная на NestJS, Prisma и MySQL.

## Возможности

- **Аутентификация**: Аутентификация на основе JWT с управлением доступом на основе ролей
- **Управление событиями**: Операции CRUD для событий
- **Система бронирования**: Отслеживание и управление доступностью мест
- **Безопасность**: Ограничение частоты запросов, проверка входных данных и глобальная обработка исключений
- **Документация**: Документация API Swagger
- **Логирование**: Асинхронное логирование с помощью Winston
- **Тестирование**: Модульные и интеграционные тесты
- **Кэширование**: Кэширование данных с помощью Redis
- **Очереди**: Обработка фоновых задач с помощью Redis и BullMQ
- **Управление токенами**: Отзыв токенов с помощью Redis

## Стек технологий

- **Фреймворк**: NestJS v11 + TypeScript
- **База данных**: MySQL с Prisma ORM
- **Аутентификация**: JWT через `@nestjs/jwt` и Passport
- **Валидация**: `class-validator` + `class-transformer`
- **Логирование**: Winston
- **Ограничение частоты запросов**: `@nestjs/throttler` с хранением в Redis
- **Кэширование**: Redis
- **Очереди**: BullMQ с Redis
- **Документация API**: Swagger/OpenAPI через `@nestjs/swagger`
- **Тестирование**: Jest + Supertest

## Настройка

1. Установите зависимости:
   ```bash
   npm install
   ```

2. Запустите базу данных и Redis:
   ```bash
   docker-compose up -d
   ```

3. Скопируйте файл `.env.example` в `.env` и при необходимости измените значения:
   ```bash
   cp .env.example .env
   ```

4. Сгенерируйте клиент Prisma:
   ```bash
   npm run prisma:generate
   ```

5. Запустите миграции базы данных:
   ```bash
   npm run prisma:migrate
   ```

6. Запустите сервер разработки:
   ```bash
   npm run start:dev
   ```

7. Доступ к документации API:
   Откройте `http://localhost:3000/api` в вашем браузере

## Конечные точки API

### Аутентификация
- `POST /auth/register` - Регистрация пользователя
- `POST /auth/login` - Вход пользователя

### События
- `POST /events` - Создание события (только для администратора)
- `GET /events` - Список всех событий
- `GET /events/:id` - Получение деталей события
- `PATCH /events/:id` - Обновление события (только для администратора)
- `DELETE /events/:id` - Удаление события (только для администратора)

### Бронирования
- `POST /bookings` - Создание бронирования
- `GET /bookings` - Список бронирований пользователя (или всех для администратора)
- `GET /bookings/:id` - Получение деталей бронирования
- `DELETE /bookings/:id` - Отмена бронирования

### Система
- `GET /` - Приветственное сообщение
- `GET /health` - Проверка состояния
- `GET /api` - Документация Swagger

## Использование Redis

Система использует Redis для следующих целей:

1. **Ограничение частоты запросов**: Хранение данных о запросах для реализации rate limiting
2. **Кэширование**: Кэширование часто запрашиваемых данных (например, списка событий)
3. **Управление токенами**: Хранение отозванных JWT токенов для реализации выхода из системы
4. **Очереди**: Обработка фоновых задач (например, отправка уведомлений)

Для локальной разработки Redis запускается через Docker Compose. В production среде укажите параметры подключения к Redis в файле `.env`.

## Тестирование

- Модульные тесты: `npm run test`
- Режим наблюдения: `npm run test:watch`
- Покрытие: `npm run test:cov`
- E2E тесты: `npm run test:e2e`
